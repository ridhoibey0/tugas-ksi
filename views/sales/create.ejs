<% 
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  }).format(amount);
};
%>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Warung POS</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    .sidebar-link.active {
      background-color: #dbeafe;
      color: #2563eb;
      border-right: 4px solid #2563eb;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen overflow-hidden">
    <%- include('../partials/sidebar', { page }) %>
    
    <main class="flex-1 overflow-y-auto">
      <%- include('../partials/header', { title }) %>
      
      <div class="p-4 md:p-8">
        <div class="max-w-5xl mx-auto">
          <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
            <form method="POST" action="/sales" id="salesForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Nama Customer (Opsional)</label>
                  <input type="text" name="customer_name" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                  <select name="payment_method" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="cash">Cash</option>
                    <option value="transfer">Transfer</option>
                    <option value="e-wallet">E-Wallet</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-4 md:mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Item Penjualan</label>
                <div class="bg-gray-50 p-3 md:p-4 rounded-lg mb-4">
                  <div class="flex flex-col sm:flex-row gap-2 mb-2">
                    <div class="flex-1">
                      <select id="productSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Pilih Produk</option>
                        <% products.forEach(product => { %>
                          <option value="<%= product.id %>" 
                                  data-name="<%= product.name %>" 
                                  data-price="<%= product.price %>"
                                  data-stock="<%= product.stock %>"
                                  data-unit="<%= product.unit %>">
                            <%= product.name %> - <%= formatCurrency(product.price) %>
                          </option>
                        <% }); %>
                      </select>
                    </div>
                    <div class="w-full sm:w-24">
                      <input type="number" id="quantityInput" placeholder="Jumlah" min="1" 
                             class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="w-full sm:w-auto">
                      <button type="button" onclick="addItem()" 
                              class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus"></i> Tambah
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="overflow-x-auto -mx-4 md:mx-0">
                  <table class="w-full min-w-[500px]">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Produk</th>
                        <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Harga</th>
                        <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Jumlah</th>
                        <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Subtotal</th>
                        <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="itemsTable">
                      <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                          Belum ada item
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="border-t pt-6">
                <div class="grid grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Bayar *</label>
                      <input type="number" name="paid_amount" id="paidAmount" required step="1" 
                             onkeyup="calculateChange()"
                             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>
                  
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="space-y-2">
                      <div class="flex justify-between">
                        <span class="text-gray-600">Total:</span>
                        <span class="font-bold text-xl" id="totalDisplay">Rp 0</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Bayar:</span>
                        <span class="font-semibold" id="paidDisplay">Rp 0</span>
                      </div>
                      <div class="flex justify-between pt-2 border-t">
                        <span class="text-gray-600">Kembali:</span>
                        <span class="font-bold text-green-600" id="changeDisplay">Rp 0</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <input type="hidden" name="items" id="itemsData">
              
              <div class="flex items-center space-x-4 pt-6">
                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 text-lg font-medium">
                  <i class="fas fa-check"></i> Proses Penjualan
                </button>
                <a href="/sales" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                  <i class="fas fa-times"></i> Batal
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    let items = [];
    let total = 0;
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }
    
    function addItem() {
      const select = document.getElementById('productSelect');
      const quantity = parseInt(document.getElementById('quantityInput').value);
      
      if (!select.value || !quantity || quantity <= 0) {
        alert('Pilih produk dan masukkan jumlah yang valid');
        return;
      }
      
      const option = select.options[select.selectedIndex];
      const stock = parseInt(option.dataset.stock);
      
      if (quantity > stock) {
        alert('Stok tidak mencukupi! Stok tersedia: ' + stock);
        return;
      }
      
      const item = {
        product_id: parseInt(select.value),
        name: option.dataset.name,
        price: parseFloat(option.dataset.price),
        quantity: quantity,
        unit: option.dataset.unit
      };
      
      // Check if item already exists
      const existingIndex = items.findIndex(i => i.product_id === item.product_id);
      if (existingIndex >= 0) {
        items[existingIndex].quantity += quantity;
      } else {
        items.push(item);
      }
      
      updateTable();
      select.value = '';
      document.getElementById('quantityInput').value = '';
    }
    
    function removeItem(index) {
      items.splice(index, 1);
      updateTable();
    }
    
    function updateTable() {
      const tbody = document.getElementById('itemsTable');
      total = 0;
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada item</td></tr>';
      } else {
        tbody.innerHTML = items.map((item, index) => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          
          return `
            <tr>
              <td class="px-4 py-2">${item.name}</td>
              <td class="px-4 py-2">${formatCurrency(item.price)}</td>
              <td class="px-4 py-2">${item.quantity} ${item.unit}</td>
              <td class="px-4 py-2 font-semibold">${formatCurrency(subtotal)}</td>
              <td class="px-4 py-2">
                <button type="button" onclick="removeItem(${index})" 
                        class="text-red-600 hover:text-red-800">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      document.getElementById('totalDisplay').textContent = formatCurrency(total);
      document.getElementById('itemsData').value = JSON.stringify(items);
      calculateChange();
    }
    
    function calculateChange() {
      const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
      const change = paid - total;
      
      document.getElementById('paidDisplay').textContent = formatCurrency(paid);
      document.getElementById('changeDisplay').textContent = formatCurrency(change);
    }
    
    document.getElementById('salesForm').addEventListener('submit', function(e) {
      if (items.length === 0) {
        e.preventDefault();
        alert('Tambahkan minimal 1 item untuk melanjutkan');
        return;
      }
      
      const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
      if (paid < total) {
        e.preventDefault();
        alert('Jumlah bayar kurang dari total');
        return;
      }
    });
  </script>
</body>
</html>
